<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åª’ä½“æ–‡ä»¶è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        
        .debug-section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .debug-title {
            color: #00ffff;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffff00; }
        .info { color: #00ffff; }
        
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #555;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        
        button:hover {
            background: #444;
        }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-ok { background: #00ff00; }
        .status-error { background: #ff0000; }
        .status-warning { background: #ffff00; }
    </style>
</head>
<body>
    <h1>ğŸ”§ åª’ä½“æ–‡ä»¶è°ƒè¯•å·¥å…·</h1>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</div>
        <div id="systemStatus">æ­£åœ¨æ£€æŸ¥...</div>
        <button onclick="checkSystemStatus()">é‡æ–°æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ’¾ localStorage å†…å®¹åˆ†æ</div>
        <div id="localStorageStatus">æ­£åœ¨åˆ†æ...</div>
        <button onclick="analyzeLocalStorage()">åˆ†æ localStorage</button>
        <button onclick="clearLocalStorage()">æ¸…é™¤ localStorage</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ¬ MediaManager çŠ¶æ€</div>
        <div id="mediaManagerStatus">æ­£åœ¨æ£€æŸ¥...</div>
        <button onclick="testMediaManager()">æµ‹è¯• MediaManager</button>
        <button onclick="forceReloadMedia()">å¼ºåˆ¶é‡è½½åª’ä½“</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ¯ å¹»ç¯ç‰‡å…ƒç´ æ£€æŸ¥</div>
        <div id="slideElementsStatus">æ­£åœ¨æ£€æŸ¥...</div>
        <button onclick="checkSlideElements()">æ£€æŸ¥å¹»ç¯ç‰‡å…ƒç´ </button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ§ª æµ‹è¯•å·¥å…·</div>
        <input type="file" id="testFileInput" accept="image/*,video/*" style="margin: 10px 0;">
        <br>
        <button onclick="testFileUpload()">æµ‹è¯•æ–‡ä»¶ä¸Šä¼ åˆ°slide 1</button>
        <button onclick="simulateMediaFiles()">åˆ›å»ºæ¨¡æ‹Ÿåª’ä½“æ–‡ä»¶</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ“ è°ƒè¯•æ—¥å¿—</div>
        <div class="log" id="debugLog">è°ƒè¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...\n</div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <button onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">ğŸ”— å¿«é€Ÿé“¾æ¥</div>
        <button onclick="window.open('index.html', '_blank')">æ‰“å¼€ä¸»å¹»ç¯ç‰‡</button>
        <button onclick="window.open('media-manager.html', '_blank')">æ‰“å¼€åª’ä½“ç®¡ç†</button>
        <button onclick="location.reload()">åˆ·æ–°è°ƒè¯•é¡µé¢</button>
    </div>

    <script src="media-manager.js"></script>
    <script>
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const colorMap = {
                'info': '#00ffff',
                'success': '#00ff00', 
                'error': '#ff0000',
                'warning': '#ffff00'
            };
            
            const logEntry = `[${timestamp}] ${message}\n`;
            logElement.innerHTML += `<span style="color: ${colorMap[type]}">${logEntry}</span>`;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[DEBUG] ${message}`);
        }

        // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        function checkSystemStatus() {
            log('å¼€å§‹ç³»ç»ŸçŠ¶æ€æ£€æŸ¥...', 'info');
            const statusDiv = document.getElementById('systemStatus');
            let statusHTML = '';
            
            // æ£€æŸ¥å…³é”®å¯¹è±¡å’Œå‡½æ•°
            const checks = [
                { name: 'MediaManagerç±»', test: () => typeof window.MediaManager !== 'undefined' },
                { name: 'localStorageæ”¯æŒ', test: () => typeof Storage !== 'undefined' },
                { name: 'FileReaderæ”¯æŒ', test: () => typeof FileReader !== 'undefined' },
                { name: 'URL.createObjectURLæ”¯æŒ', test: () => typeof URL.createObjectURL !== 'undefined' },
                { name: 'HTML5è§†é¢‘æ”¯æŒ', test: () => !!document.createElement('video').canPlayType },
                { name: 'Canvasæ”¯æŒ', test: () => !!document.createElement('canvas').getContext }
            ];
            
            checks.forEach(check => {
                const result = check.test();
                const status = result ? 'ok' : 'error';
                const icon = result ? 'âœ…' : 'âŒ';
                statusHTML += `<div><span class="status-indicator status-${status}"></span>${icon} ${check.name}: ${result ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}</div>`;
                log(`${check.name}: ${result ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`, result ? 'success' : 'error');
            });
            
            statusDiv.innerHTML = statusHTML;
        }

        // localStorage åˆ†æ
        function analyzeLocalStorage() {
            log('åˆ†ælocalStorageå†…å®¹...', 'info');
            const statusDiv = document.getElementById('localStorageStatus');
            
            try {
                const savedData = localStorage.getItem('slideshowMediaFiles');
                if (!savedData) {
                    statusDiv.innerHTML = '<span class="error">âŒ æ²¡æœ‰æ‰¾åˆ°åª’ä½“æ–‡ä»¶æ•°æ®</span>';
                    log('localStorageä¸­æ²¡æœ‰æ‰¾åˆ°slideshowMediaFilesæ•°æ®', 'error');
                    return;
                }
                
                const mediaData = JSON.parse(savedData);
                const fileCount = Object.keys(mediaData).length;
                
                let analysisHTML = `<div class="success">âœ… æ‰¾åˆ° ${fileCount} ä¸ªåª’ä½“æ–‡ä»¶:</div>`;
                
                Object.entries(mediaData).forEach(([slideNumber, data]) => {
                    const hasUrl = !!data.url;
                    const isBase64 = data.url && data.url.startsWith('data:');
                    const fileSize = data.fileSize ? `${Math.round(data.fileSize/1024)}KB` : 'æœªçŸ¥';
                    
                    analysisHTML += `
                        <div style="margin-left: 20px; margin-top: 5px;">
                            ğŸ“„ ç¬¬${slideNumber}å¼ : ${data.slideName || 'æœªçŸ¥'}
                            <br>&nbsp;&nbsp;&nbsp;ç±»å‹: ${data.type || 'æœªçŸ¥'} | å¤§å°: ${fileSize}
                            <br>&nbsp;&nbsp;&nbsp;URL: ${hasUrl ? (isBase64 ? 'âœ… Base64æ•°æ®' : 'âš ï¸  Blob URL') : 'âŒ æ— URL'}
                            <br>&nbsp;&nbsp;&nbsp;æ—¶é—´: ${data.timestamp || 'æœªçŸ¥'}
                        </div>
                    `;
                    
                    log(`å‘ç°æ–‡ä»¶ - ç¬¬${slideNumber}å¼ : ${data.type}, URLç±»å‹: ${isBase64 ? 'Base64' : hasUrl ? 'Blob' : 'æ— '}`, hasUrl ? 'success' : 'error');
                });
                
                statusDiv.innerHTML = analysisHTML;
                
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">âŒ è§£ælocalStorageæ•°æ®å¤±è´¥: ${error.message}</span>`;
                log(`localStorageæ•°æ®è§£æå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // MediaManager æµ‹è¯•
        function testMediaManager() {
            log('æµ‹è¯•MediaManager...', 'info');
            const statusDiv = document.getElementById('mediaManagerStatus');
            
            if (typeof window.MediaManager === 'undefined') {
                statusDiv.innerHTML = '<span class="error">âŒ MediaManagerç±»æœªåŠ è½½</span>';
                log('MediaManagerç±»æœªå®šä¹‰', 'error');
                return;
            }
            
            try {
                // åˆ›å»ºMediaManagerå®ä¾‹
                const mediaManager = new MediaManager();
                log('âœ… MediaManagerå®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                
                // æ£€æŸ¥åª’ä½“ç¼“å­˜
                const cacheInfo = mediaManager.getMediaInfo ? mediaManager.getMediaInfo() : 'æ–¹æ³•ä¸å­˜åœ¨';
                log(`åª’ä½“ç¼“å­˜ä¿¡æ¯: ${JSON.stringify(cacheInfo)}`, 'info');
                
                // æµ‹è¯•ç”¨æˆ·ä¸Šä¼ åª’ä½“åŠ è½½
                mediaManager.loadUserUploadedMedia();
                
                statusDiv.innerHTML = `
                    <div class="success">âœ… MediaManagerå·¥ä½œæ­£å¸¸</div>
                    <div>ç¼“å­˜çš„åª’ä½“æ•°é‡: ${mediaManager.mediaCache ? mediaManager.mediaCache.size : 'æœªçŸ¥'}</div>
                `;
                
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">âŒ MediaManageræµ‹è¯•å¤±è´¥: ${error.message}</span>`;
                log(`MediaManageræµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥å¹»ç¯ç‰‡å…ƒç´ 
        function checkSlideElements() {
            log('æ£€æŸ¥å¹»ç¯ç‰‡DOMå…ƒç´ ...', 'info');
            const statusDiv = document.getElementById('slideElementsStatus');
            
            // ç”±äºè¿™æ˜¯è°ƒè¯•é¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ä¸»é¡µé¢çš„å…ƒç´ 
            // è¿™é‡Œæˆ‘ä»¬æ£€æŸ¥å…³é”®çš„é€‰æ‹©å™¨æ˜¯å¦æœ‰æ•ˆ
            const selectors = [
                '.slide',
                '.visual', 
                '.slide-content',
                '#slideshow',
                '.slides'
            ];
            
            let statusHTML = '<div class="info">ğŸ“‹ å…³é”®é€‰æ‹©å™¨æ£€æŸ¥ (éœ€è¦åœ¨ä¸»é¡µé¢ä¸­è¿è¡Œ):</div>';
            
            selectors.forEach(selector => {
                statusHTML += `<div style="margin-left: 20px;">ğŸ” ${selector}</div>`;
            });
            
            statusHTML += '<div class="warning">âš ï¸  åœ¨ä¸»å¹»ç¯ç‰‡é¡µé¢æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>';
            
            statusDiv.innerHTML = statusHTML;
            log('å¹»ç¯ç‰‡å…ƒç´ æ£€æŸ¥å®Œæˆ - éœ€è¦åœ¨ä¸»é¡µé¢éªŒè¯', 'info');
        }

        // æµ‹è¯•æ–‡ä»¶ä¸Šä¼ 
        function testFileUpload() {
            const fileInput = document.getElementById('testFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                log('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶', 'warning');
                return;
            }
            
            log(`å¼€å§‹æµ‹è¯•æ–‡ä»¶ä¸Šä¼ : ${file.name} (${file.type}, ${Math.round(file.size/1024)}KB)`, 'info');
            
            // æ¨¡æ‹Ÿåª’ä½“ç®¡ç†å™¨çš„ä¸Šä¼ è¿‡ç¨‹
            const reader = new FileReader();
            reader.onload = function(e) {
                const mediaData = {
                    1: {
                        url: e.target.result,
                        type: file.type.startsWith('video/') ? 'video' : 'image',
                        slideNumber: 1,
                        slideName: 'çˆ±ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ',
                        timestamp: new Date().toLocaleString(),
                        fileName: file.name,
                        fileSize: file.size,
                        mimeType: file.type
                    }
                };
                
                localStorage.setItem('slideshowMediaFiles', JSON.stringify(mediaData));
                log('âœ… æµ‹è¯•æ–‡ä»¶å·²ä¿å­˜åˆ°localStorage (ç¬¬1å¼ å¹»ç¯ç‰‡)', 'success');
                
                // é‡æ–°åˆ†ælocalStorage
                analyzeLocalStorage();
            };
            
            reader.onerror = function() {
                log('âŒ æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            };
            
            reader.readAsDataURL(file);
        }

        // åˆ›å»ºæ¨¡æ‹Ÿåª’ä½“æ–‡ä»¶
        function simulateMediaFiles() {
            log('åˆ›å»ºæ¨¡æ‹Ÿåª’ä½“æ–‡ä»¶...', 'info');
            
            // åˆ›å»ºä¸€ä¸ªç®€å•çš„1åƒç´ å›¾ç‰‡çš„base64æ•°æ®
            const simpleImageBase64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChAI/hRBQYwAAAABJRU5ErkJggg==';
            
            const simulatedData = {
                1: {
                    url: simpleImageBase64,
                    type: 'image',
                    slideNumber: 1,
                    slideName: 'çˆ±ï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ',
                    timestamp: new Date().toLocaleString(),
                    fileName: 'test1.png',
                    fileSize: 1024,
                    mimeType: 'image/png'
                },
                2: {
                    url: simpleImageBase64,
                    type: 'image', 
                    slideNumber: 2,
                    slideName: 'ä½ ä¸ä½ çš„èº«ä½“ï¼Œæ˜¯æœ‹å‹å—ï¼Ÿ',
                    timestamp: new Date().toLocaleString(),
                    fileName: 'test2.png',
                    fileSize: 1024,
                    mimeType: 'image/png'
                }
            };
            
            localStorage.setItem('slideshowMediaFiles', JSON.stringify(simulatedData));
            log('âœ… å·²åˆ›å»º2ä¸ªæ¨¡æ‹Ÿåª’ä½“æ–‡ä»¶', 'success');
            
            // é‡æ–°åˆ†æ
            analyzeLocalStorage();
        }

        // å¼ºåˆ¶é‡è½½åª’ä½“
        function forceReloadMedia() {
            log('å¼ºåˆ¶é‡è½½åª’ä½“æ–‡ä»¶...', 'info');
            
            if (typeof window.MediaManager === 'undefined') {
                log('âŒ MediaManageræœªåŠ è½½ï¼Œæ— æ³•é‡è½½', 'error');
                return;
            }
            
            try {
                const mediaManager = new MediaManager();
                mediaManager.loadUserUploadedMedia();
                log('âœ… åª’ä½“é‡è½½å®Œæˆ', 'success');
            } catch (error) {
                log(`âŒ åª’ä½“é‡è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤localStorage
        function clearLocalStorage() {
            localStorage.removeItem('slideshowMediaFiles');
            log('ğŸ—‘ï¸  å·²æ¸…é™¤localStorageä¸­çš„åª’ä½“æ–‡ä»¶', 'warning');
            analyzeLocalStorage();
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLog() {
            const logContent = document.getElementById('debugLog').textContent;
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-log-${new Date().toISOString().slice(0,19)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæ£€æŸ¥
        window.addEventListener('load', function() {
            log('ğŸš€ åª’ä½“è°ƒè¯•å·¥å…·åŠ è½½å®Œæˆ', 'success');
            checkSystemStatus();
            analyzeLocalStorage();
            
            // ç›‘å¬localStorageå˜åŒ–
            window.addEventListener('storage', function(e) {
                if (e.key === 'slideshowMediaFiles') {
                    log('ğŸ”„ æ£€æµ‹åˆ°localStorageå˜åŒ–ï¼Œé‡æ–°åˆ†æ...', 'info');
                    analyzeLocalStorage();
                }
            });
        });
    </script>
</body>
</html>