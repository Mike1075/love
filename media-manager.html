<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>媒体文件管理 - 真爱之旅</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav-links a {
            color: #ffd700;
            text-decoration: none;
            margin: 0 15px;
            padding: 10px 20px;
            border: 2px solid #ffd700;
            border-radius: 25px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .nav-links a:hover {
            background: #ffd700;
            color: #333;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 1rem;
            opacity: 0.7;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .slide-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .slide-selector label {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .slide-selector select {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1rem;
            cursor: pointer;
        }

        .slide-selector select option {
            background: #333;
            color: white;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0;
            transition: width 0.3s ease;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .media-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .media-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .media-preview {
            width: 100%;
            height: 150px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .media-preview img,
        .media-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-preview .placeholder {
            font-size: 2rem;
            opacity: 0.5;
        }

        .media-info {
            text-align: center;
        }

        .media-info h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .media-info p {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .media-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .status-success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .status-error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .slide-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .slide-info h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .slide-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
        }

        .slide-item {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #ffd700;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .upload-area {
                padding: 40px 15px;
            }

            .media-grid {
                grid-template-columns: 1fr;
            }

            .slide-selector {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📁 媒体文件管理</h1>
            <p>为幻灯片添加精美的视频和图片</p>
        </div>

        <div class="nav-links">
            <a href="index.html">🎬 返回幻灯片</a>
            <a href="test.html">🧪 测试页面</a>
            <a href="#" onclick="window.open('https://github.com/Mike1075/love', '_blank')">📂 项目源码</a>
        </div>

        <div class="status-message" id="statusMessage"></div>

        <div class="slide-info">
            <h3>📋 幻灯片列表</h3>
            <div class="slide-list">
                <div class="slide-item">1. 爱，到底是什么？</div>
                <div class="slide-item">2. 你与你的身体，是朋友吗？</div>
                <div class="slide-item">3. 你生命中最强大的力量</div>
                <div class="slide-item">4. 真爱之旅 (标题页)</div>
                <div class="slide-item">5. 欢迎，勇敢的探索者</div>
                <div class="slide-item">6. 我们神圣的约定</div>
                <div class="slide-item">7. 练习一：心之所向</div>
                <div class="slide-item">8. 向外索取的商品？</div>
                <div class="slide-item">9. 性能量 = 生命力</div>
                <div class="slide-item">10. 被堵塞的生命之河</div>
                <div class="slide-item">11. 练习二：写给身体的忏悔录</div>
                <div class="slide-item">12. 阴与阳的内在共舞</div>
                <div class="slide-item">13. 头脑控制身体？</div>
                <div class="slide-item">14. 练习三：动态静心</div>
                <div class="slide-item">15. 第一阶段：混乱式呼吸</div>
                <div class="slide-item">16. 第二阶段：能量宣泄</div>
                <div class="slide-item">17. 第三阶段：静止与观照</div>
                <div class="slide-item">18. 第四阶段：庆祝之舞</div>
                <div class="slide-item">19. 静默午餐</div>
                <div class="slide-item">20. 光进入你内心的地方</div>
                <div class="slide-item">21. 创伤的本质</div>
                <div class="slide-item">22. 练习四：心与根的连接</div>
                <div class="slide-item">23. 关系，是通往自我的桥梁</div>
                <div class="slide-item">24. 练习五：灵魂的凝视</div>
                <div class="slide-item">25. 重生之旅</div>
                <div class="slide-item">26. 意图引导</div>
                <div class="slide-item">27. 第一步：连接</div>
                <div class="slide-item">28. 第二步：回顾与告别</div>
                <div class="slide-item">29. 第三步：新生与庆祝</div>
                <div class="slide-item">30. 第四步：拥抱与融合</div>
                <div class="slide-item">31. 旅程，现在才真正开始</div>
                <div class="slide-item">32. 感谢您的临在与敞开</div>
            </div>
        </div>

        <div class="upload-section">
            <h2>📤 上传媒体文件</h2>
            
            <div class="slide-selector">
                <label for="slideSelect">选择幻灯片：</label>
                <select id="slideSelect">
                    <option value="">请选择幻灯片编号...</option>
                </select>
                <span id="slideTitle" style="font-style: italic; opacity: 0.8;"></span>
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📁</div>
                <div class="upload-text">拖拽文件到这里或点击选择</div>
                <div class="upload-hint">支持 MP4, WebM, OGG 视频和 JPG, PNG, WebP 图片</div>
                <input type="file" id="fileInput" class="file-input" multiple accept="video/*,image/*">
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <div class="media-grid" id="mediaGrid">
            <!-- 媒体文件卡片将在这里动态生成 -->
        </div>
    </div>

    <script>
        class MediaUploadManager {
            constructor() {
                this.mediaFiles = new Map();
                this.slideNames = [
                    "", // 0 - 占位符
                    "爱，到底是什么？",
                    "你与你的身体，是朋友吗？",
                    "你生命中最强大的力量",
                    "真爱之旅 (标题页)",
                    "欢迎，勇敢的探索者",
                    "我们神圣的约定",
                    "练习一：心之所向",
                    "向外索取的商品？",
                    "性能量 = 生命力",
                    "被堵塞的生命之河",
                    "练习二：写给身体的忏悔录",
                    "阴与阳的内在共舞",
                    "头脑控制身体？",
                    "练习三：动态静心",
                    "第一阶段：混乱式呼吸",
                    "第二阶段：能量宣泄",
                    "第三阶段：静止与观照",
                    "第四阶段：庆祝之舞",
                    "静默午餐",
                    "光进入你内心的地方",
                    "创伤的本质",
                    "练习四：心与根的连接",
                    "关系，是通往自我的桥梁",
                    "练习五：灵魂的凝视",
                    "重生之旅",
                    "意图引导",
                    "第一步：连接",
                    "第二步：回顾与告别",
                    "第三步：新生与庆祝",
                    "第四步：拥抱与融合",
                    "旅程，现在才真正开始",
                    "感谢您的临在与敞开"
                ];
                
                this.init();
            }

            init() {
                this.setupElements();
                this.bindEvents();
                this.populateSlideSelector();
                this.loadExistingMedia();
            }

            setupElements() {
                this.uploadArea = document.getElementById('uploadArea');
                this.fileInput = document.getElementById('fileInput');
                this.slideSelect = document.getElementById('slideSelect');
                this.slideTitle = document.getElementById('slideTitle');
                this.progressContainer = document.getElementById('progressContainer');
                this.progressFill = document.getElementById('progressFill');
                this.statusMessage = document.getElementById('statusMessage');
                this.mediaGrid = document.getElementById('mediaGrid');
            }

            bindEvents() {
                // 文件选择事件
                this.fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));
                
                // 拖拽事件
                this.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.add('dragover');
                });
                
                this.uploadArea.addEventListener('dragleave', () => {
                    this.uploadArea.classList.remove('dragover');
                });
                
                this.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.remove('dragover');
                    this.handleFiles(e.dataTransfer.files);
                });

                // 幻灯片选择事件
                this.slideSelect.addEventListener('change', (e) => {
                    const slideNumber = parseInt(e.target.value);
                    if (slideNumber) {
                        this.slideTitle.textContent = this.slideNames[slideNumber];
                    } else {
                        this.slideTitle.textContent = '';
                    }
                });
            }

            populateSlideSelector() {
                for (let i = 1; i <= 32; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `第${i}张 - ${this.slideNames[i]}`;
                    this.slideSelect.appendChild(option);
                }
            }

            handleFiles(files) {
                Array.from(files).forEach(file => {
                    if (this.validateFile(file)) {
                        this.processFile(file);
                    }
                });
            }

            validateFile(file) {
                const validTypes = [
                    'video/mp4', 'video/webm', 'video/ogg',
                    'image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'
                ];
                
                if (!validTypes.includes(file.type)) {
                    this.showStatus('不支持的文件格式！', 'error');
                    return false;
                }
                
                if (file.size > 50 * 1024 * 1024) { // 50MB
                    this.showStatus('文件太大，请选择小于50MB的文件！', 'error');
                    return false;
                }
                
                return true;
            }

            processFile(file) {
                // 检测文件名中的数字
                const filename = file.name;
                const numberMatch = filename.match(/^(\d+)\./);
                let slideNumber = numberMatch ? parseInt(numberMatch[1]) : null;
                
                // 如果文件名没有数字，使用选择的幻灯片
                if (!slideNumber) {
                    slideNumber = parseInt(this.slideSelect.value);
                }
                
                if (!slideNumber || slideNumber < 1 || slideNumber > 32) {
                    this.showStatus('请选择有效的幻灯片编号或在文件名前加上数字！', 'error');
                    return;
                }

                this.uploadFile(file, slideNumber);
            }

            uploadFile(file, slideNumber) {
                this.showProgress();
                
                // 模拟上传进度
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        this.hideProgress();
                        this.addMediaFile(file, slideNumber);
                        this.showStatus(`文件已添加到第${slideNumber}张幻灯片！`, 'success');
                    }
                    this.updateProgress(progress);
                }, 100);
            }

            addMediaFile(file, slideNumber) {
                const url = URL.createObjectURL(file);
                
                // 将文件转换为Base64以便持久保存
                const reader = new FileReader();
                reader.onload = (e) => {
                    const mediaData = {
                        file: file,
                        url: url, // 临时URL用于当前页面
                        base64: e.target.result, // Base64数据用于持久保存
                        type: file.type.startsWith('video/') ? 'video' : 'image',
                        slideNumber: slideNumber,
                        slideName: this.slideNames[slideNumber],
                        timestamp: new Date().toLocaleString(),
                        fileName: file.name,
                        fileSize: file.size,
                        mimeType: file.type
                    };

                    this.mediaFiles.set(slideNumber, mediaData);
                    this.updateMediaGrid();
                    this.saveToLocalStorage();
                };
                reader.readAsDataURL(file);
            }

            updateMediaGrid() {
                this.mediaGrid.innerHTML = '';
                
                // 按幻灯片编号排序
                const sortedMedia = Array.from(this.mediaFiles.entries()).sort((a, b) => a[0] - b[0]);
                
                sortedMedia.forEach(([slideNumber, mediaData]) => {
                    const card = this.createMediaCard(mediaData);
                    this.mediaGrid.appendChild(card);
                });
            }

            createMediaCard(mediaData) {
                const card = document.createElement('div');
                card.className = 'media-card';
                
                card.innerHTML = `
                    <div class="media-preview">
                        ${mediaData.type === 'video' 
                            ? `<video src="${mediaData.url}" controls muted></video>`
                            : `<img src="${mediaData.url}" alt="Slide ${mediaData.slideNumber}">`
                        }
                    </div>
                    <div class="media-info">
                        <h3>第${mediaData.slideNumber}张幻灯片</h3>
                        <p>${mediaData.slideName}</p>
                        <p>类型: ${mediaData.type === 'video' ? '视频' : '图片'}</p>
                        <p>大小: ${this.formatFileSize(mediaData.file.size)}</p>
                        <p>添加时间: ${mediaData.timestamp}</p>
                    </div>
                    <div class="media-actions">
                        <button class="btn btn-primary" onclick="mediaManager.previewInSlideshow(${mediaData.slideNumber})">预览</button>
                        <button class="btn btn-danger" onclick="mediaManager.removeMedia(${mediaData.slideNumber})">删除</button>
                    </div>
                `;
                
                return card;
            }

            previewInSlideshow(slideNumber) {
                // 在新窗口打开幻灯片并跳转到指定页面
                const url = `index.html#slide=${slideNumber}`;
                window.open(url, '_blank');
            }

            removeMedia(slideNumber) {
                if (confirm(`确定要删除第${slideNumber}张幻灯片的媒体文件吗？`)) {
                    const mediaData = this.mediaFiles.get(slideNumber);
                    if (mediaData) {
                        URL.revokeObjectURL(mediaData.url);
                        this.mediaFiles.delete(slideNumber);
                        this.updateMediaGrid();
                        this.saveToLocalStorage();
                        this.showStatus(`已删除第${slideNumber}张幻灯片的媒体文件`, 'success');
                    }
                }
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            showProgress() {
                this.progressContainer.style.display = 'block';
            }

            hideProgress() {
                this.progressContainer.style.display = 'none';
                this.updateProgress(0);
            }

            updateProgress(percentage) {
                this.progressFill.style.width = percentage + '%';
            }

            showStatus(message, type) {
                this.statusMessage.textContent = message;
                this.statusMessage.className = `status-message status-${type}`;
                this.statusMessage.style.display = 'block';
                
                setTimeout(() => {
                    this.statusMessage.style.display = 'none';
                }, 3000);
            }

            saveToLocalStorage() {
                const mediaData = {};
                this.mediaFiles.forEach((data, slideNumber) => {
                    mediaData[slideNumber] = {
                        url: data.base64 || data.url, // 优先使用base64，fallback到url
                        type: data.type,
                        slideNumber: data.slideNumber,
                        slideName: data.slideName,
                        timestamp: data.timestamp,
                        fileName: data.fileName,
                        fileSize: data.fileSize,
                        mimeType: data.mimeType
                    };
                });
                localStorage.setItem('slideshowMediaFiles', JSON.stringify(mediaData));
                console.log('💾 保存了', Object.keys(mediaData).length, '个媒体文件到localStorage');
            }

            loadExistingMedia() {
                const savedData = localStorage.getItem('slideshowMediaFiles');
                if (savedData) {
                    try {
                        const mediaData = JSON.parse(savedData);
                        console.log('已加载保存的媒体文件:', Object.keys(mediaData).length + '个');
                        // 注意：从localStorage加载的URL可能已失效，这里只显示信息
                        this.updateMediaGrid();
                    } catch (error) {
                        console.error('加载媒体文件失败:', error);
                    }
                }
            }

            loadExistingMediaFromFiles() {
                // 这个方法用于从实际的media目录加载文件
                // 在实际部署中，需要后端API支持
                console.log('尝试从media目录加载现有文件...');
            }

            exportMediaList() {
                const mediaList = [];
                this.mediaFiles.forEach((data, slideNumber) => {
                    mediaList.push({
                        slide: slideNumber,
                        name: data.slideName,
                        type: data.type,
                        fileName: data.file.name,
                        size: data.file.size
                    });
                });
                
                console.log('媒体文件列表:', mediaList);
                return mediaList;
            }
        }

        // 初始化媒体管理器
        const mediaManager = new MediaUploadManager();
        
        // 全局暴露
        window.mediaManager = mediaManager;
    </script>
</body>
</html>